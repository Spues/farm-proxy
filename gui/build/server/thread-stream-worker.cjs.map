{
  "version": 3,
  "sources": ["../../../../node_modules/real-require/src/index.js", "../../../../node_modules/thread-stream/lib/indexes.js", "../../../../node_modules/thread-stream/lib/wait.js", "../../../../node_modules/thread-stream/lib/worker.js"],
  "sourcesContent": ["/* eslint-disable no-new-func, camelcase */\n/* globals __non_webpack__require__ */\n\nconst realImport = new Function('modulePath', 'return import(modulePath)')\n\nfunction realRequire(modulePath) {\n  if (typeof __non_webpack__require__ === 'function') {\n    return __non_webpack__require__(modulePath)\n  }\n\n  return require(modulePath)\n}\n\nmodule.exports = { realImport, realRequire }\n", "'use strict'\n\nconst WRITE_INDEX = 4\nconst READ_INDEX = 8\n\nmodule.exports = {\n  WRITE_INDEX,\n  READ_INDEX\n}\n", "'use strict'\n\n// Maximum wait time for a single waitAsync call\n// Used as a fallback poll interval in case notifications are missed\n// Keep this low enough for good throughput but high enough to not busy-loop\nconst WAIT_MS = 10000\n\nfunction wait (state, index, expected, timeout, done) {\n  const max = timeout === Infinity ? Infinity : Date.now() + timeout\n\n  const check = () => {\n    const current = Atomics.load(state, index)\n    if (current === expected) {\n      done(null, 'ok')\n      return\n    }\n\n    if (max !== Infinity && Date.now() > max) {\n      done(null, 'timed-out')\n      return\n    }\n\n    // Wait for any change from current value\n    const remaining = max === Infinity ? WAIT_MS : Math.min(WAIT_MS, Math.max(1, max - Date.now()))\n    const result = Atomics.waitAsync(state, index, current, remaining)\n\n    if (result.async) {\n      result.value.then(check)\n    } else {\n      // Value already changed (not-equal) - recheck on next tick\n      setImmediate(check)\n    }\n  }\n\n  check()\n}\n\nfunction waitDiff (state, index, expected, timeout, done) {\n  const max = timeout === Infinity ? Infinity : Date.now() + timeout\n\n  const check = () => {\n    const current = Atomics.load(state, index)\n    if (current !== expected) {\n      done(null, 'ok')\n      return\n    }\n\n    if (max !== Infinity && Date.now() > max) {\n      done(null, 'timed-out')\n      return\n    }\n\n    // Wait for value to change from expected\n    const remaining = max === Infinity ? WAIT_MS : Math.min(WAIT_MS, Math.max(1, max - Date.now()))\n    const result = Atomics.waitAsync(state, index, expected, remaining)\n\n    if (result.async) {\n      result.value.then(check)\n    } else {\n      // Value already changed (not-equal) - recheck on next tick\n      setImmediate(check)\n    }\n  }\n\n  check()\n}\n\nmodule.exports = { wait, waitDiff }\n", "'use strict'\n\nconst { realImport, realRequire } = require('real-require')\nconst { workerData, parentPort } = require('worker_threads')\nconst { WRITE_INDEX, READ_INDEX } = require('./indexes')\nconst { waitDiff } = require('./wait')\n\nconst {\n  dataBuf,\n  filename,\n  stateBuf\n} = workerData\n\nlet destination\n\nconst state = new Int32Array(stateBuf)\nconst data = Buffer.from(dataBuf)\n\n// Keep the event loop alive - Atomics.waitAsync promises don't prevent worker exit\nconst keepAlive = setInterval(() => {}, 60 * 60 * 1000)\n\nasync function start () {\n  let worker\n  try {\n    worker = (await realImport(filename))\n  } catch (error) {\n    // A yarn user that tries to start a ThreadStream for an external module\n    // provides a filename pointing to a zip file.\n    // eg. require.resolve('pino-elasticsearch') // returns /foo/pino-elasticsearch-npm-6.1.0-0c03079478-6915435172.zip/bar.js\n    // The `import` will fail to try to load it.\n    // This catch block executes the `require` fallback to load the module correctly.\n    // In fact, yarn modifies the `require` function to manage the zipped path.\n    // More details at https://github.com/pinojs/pino/pull/1113\n    // The error codes may change based on the node.js version (ENOTDIR > 12, ERR_MODULE_NOT_FOUND <= 12 )\n    if ((error.code === 'ENOTDIR' || error.code === 'ERR_MODULE_NOT_FOUND') &&\n     filename.startsWith('file://')) {\n      worker = realRequire(decodeURIComponent(filename.replace('file://', '')))\n    } else if (error.code === undefined || error.code === 'ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING') {\n      // When bundled with pkg, an undefined error is thrown when called with realImport\n      // When bundled with pkg and using node v20, an ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING error is thrown when called with realImport\n      // More info at: https://github.com/pinojs/thread-stream/issues/143\n      try {\n        worker = realRequire(decodeURIComponent(filename.replace(process.platform === 'win32' ? 'file:///' : 'file://', '')))\n      } catch {\n        throw error\n      }\n    } else if (filename.endsWith('.ts') || filename.endsWith('.cts')) {\n      // Native TypeScript import failed (type stripping not enabled).\n      // Fall back to ts-node for TypeScript files.\n      try {\n        if (!process[Symbol.for('ts-node.register.instance')]) {\n          realRequire('ts-node/register')\n        } else if (process.env.TS_NODE_DEV) {\n          realRequire('ts-node-dev')\n        }\n        worker = realRequire(decodeURIComponent(filename.replace(process.platform === 'win32' ? 'file:///' : 'file://', '')))\n      } catch {\n        throw error\n      }\n    } else {\n      throw error\n    }\n  }\n\n  // Depending on how the default export is performed, and on how the code is\n  // transpiled, we may find cases of two nested \"default\" objects.\n  // See https://github.com/pinojs/pino/issues/1243#issuecomment-982774762\n  if (typeof worker === 'object') worker = worker.default\n  if (typeof worker === 'object') worker = worker.default\n\n  destination = await worker(workerData.workerData)\n\n  destination.on('error', function (err) {\n    Atomics.store(state, WRITE_INDEX, -2)\n    Atomics.notify(state, WRITE_INDEX)\n\n    Atomics.store(state, READ_INDEX, -2)\n    Atomics.notify(state, READ_INDEX)\n\n    parentPort.postMessage({\n      code: 'ERROR',\n      err\n    })\n  })\n\n  destination.on('close', function () {\n    // process._rawDebug('worker close emitted')\n    const end = Atomics.load(state, WRITE_INDEX)\n    Atomics.store(state, READ_INDEX, end)\n    Atomics.notify(state, READ_INDEX)\n    clearInterval(keepAlive)\n    setImmediate(() => {\n      process.exit(0)\n    })\n  })\n}\n\n// No .catch() handler,\n// in case there is an error it goes\n// to unhandledRejection\nstart().then(function () {\n  parentPort.postMessage({\n    code: 'READY'\n  })\n\n  process.nextTick(run)\n})\n\nfunction run () {\n  const current = Atomics.load(state, READ_INDEX)\n  const end = Atomics.load(state, WRITE_INDEX)\n\n  // process._rawDebug(`pre state ${current} ${end}`)\n\n  if (end === current) {\n    if (end === data.length) {\n      waitDiff(state, READ_INDEX, end, Infinity, run)\n    } else {\n      waitDiff(state, WRITE_INDEX, end, Infinity, run)\n    }\n    return\n  }\n\n  // process._rawDebug(`post state ${current} ${end}`)\n\n  if (end === -1) {\n    // process._rawDebug('end')\n    destination.end()\n    return\n  }\n\n  const toWrite = data.toString('utf8', current, end)\n  // process._rawDebug('worker writing: ' + toWrite)\n\n  const res = destination.write(toWrite)\n\n  if (res) {\n    Atomics.store(state, READ_INDEX, end)\n    Atomics.notify(state, READ_INDEX)\n    setImmediate(run)\n  } else {\n    destination.once('drain', function () {\n      Atomics.store(state, READ_INDEX, end)\n      Atomics.notify(state, READ_INDEX)\n      run()\n    })\n  }\n}\n\nprocess.on('unhandledRejection', function (err) {\n  parentPort.postMessage({\n    code: 'ERROR',\n    err\n  })\n  process.exit(1)\n})\n\nprocess.on('uncaughtException', function (err) {\n  parentPort.postMessage({\n    code: 'ERROR',\n    err\n  })\n  process.exit(1)\n})\n\nprocess.once('exit', exitCode => {\n  if (exitCode !== 0) {\n    process.exit(exitCode)\n    return\n  }\n  if (destination?.writableNeedDrain && !destination?.writableEnded) {\n    parentPort.postMessage({\n      code: 'WARNING',\n      err: new Error('ThreadStream: process exited before destination stream was drained. this may indicate that the destination stream try to write to a another missing stream')\n    })\n  }\n\n  process.exit(0)\n})\n"],
  "mappings": "4LAAA,iFAAAA,SAAAC,QAAA,CAGA,IAAMC,YAAa,IAAI,SAAS,aAAc,2BAA2B,EAEzE,SAASC,aAAY,WAAY,CAC/B,OAAI,OAAO,0BAA6B,WAC/B,yBAAyB,UAAU,EAGrC,QAAQ,UAAU,CAC3B,CAEAF,QAAO,QAAU,CAAE,WAAAC,YAAY,YAAAC,YAAY,KCb3C,wFAAAC,SAAAC,QAAA,cAKAA,QAAO,QAAU,CACf,cACA,YACF,KCRA,kFAAAC,SAAAC,QAAA,cAOA,SAAS,KAAMC,OAAO,MAAO,SAAU,QAAS,KAAM,CACpD,IAAM,IAAM,UAAY,IAAW,IAAW,KAAK,IAAI,EAAI,QAErD,MAAQ,IAAM,CAClB,IAAM,QAAU,QAAQ,KAAKA,OAAO,KAAK,EACzC,GAAI,UAAY,SAAU,CACxB,KAAK,KAAM,IAAI,EACf,MACF,CAEA,GAAI,MAAQ,KAAY,KAAK,IAAI,EAAI,IAAK,CACxC,KAAK,KAAM,WAAW,EACtB,MACF,CAGA,IAAM,UAAY,MAAQ,IAAW,IAAU,KAAK,IAAI,IAAS,KAAK,IAAI,EAAG,IAAM,KAAK,IAAI,CAAC,CAAC,EACxF,OAAS,QAAQ,UAAUA,OAAO,MAAO,QAAS,SAAS,EAE7D,OAAO,MACT,OAAO,MAAM,KAAK,KAAK,EAGvB,aAAa,KAAK,CAEtB,EAEA,MAAM,CACR,CAEA,SAASC,UAAUD,OAAO,MAAO,SAAU,QAAS,KAAM,CACxD,IAAM,IAAM,UAAY,IAAW,IAAW,KAAK,IAAI,EAAI,QAErD,MAAQ,IAAM,CAElB,GADgB,QAAQ,KAAKA,OAAO,KAAK,IACzB,SAAU,CACxB,KAAK,KAAM,IAAI,EACf,MACF,CAEA,GAAI,MAAQ,KAAY,KAAK,IAAI,EAAI,IAAK,CACxC,KAAK,KAAM,WAAW,EACtB,MACF,CAGA,IAAM,UAAY,MAAQ,IAAW,IAAU,KAAK,IAAI,IAAS,KAAK,IAAI,EAAG,IAAM,KAAK,IAAI,CAAC,CAAC,EACxF,OAAS,QAAQ,UAAUA,OAAO,MAAO,SAAU,SAAS,EAE9D,OAAO,MACT,OAAO,MAAM,KAAK,KAAK,EAGvB,aAAa,KAAK,CAEtB,EAEA,MAAM,CACR,CAEAD,QAAO,QAAU,CAAE,KAAM,SAAAE,SAAS,KCjElC,GAAM,CAAE,WAAY,WAAY,EAAI,cAC9B,CAAE,WAAY,UAAW,EAAI,QAAQ,gBAAgB,EACrD,CAAE,YAAa,UAAW,EAAI,kBAC9B,CAAE,QAAS,EAAI,eAEf,CACJ,QACA,SACA,QACF,EAAI,WAEA,YAEE,MAAQ,IAAI,WAAW,QAAQ,EAC/B,KAAO,OAAO,KAAK,OAAO,EAG1B,UAAY,YAAY,IAAM,CAAC,EAAG,KAAU,GAAI,EAEtD,eAAe,OAAS,CACtB,IAAI,OACJ,GAAI,CACF,OAAU,MAAM,WAAW,QAAQ,CACrC,OAAS,MAAO,CASd,IAAK,MAAM,OAAS,WAAa,MAAM,OAAS,yBAC/C,SAAS,WAAW,SAAS,EAC5B,OAAS,YAAY,mBAAmB,SAAS,QAAQ,UAAW,EAAE,CAAC,CAAC,UAC/D,MAAM,OAAS,QAAa,MAAM,OAAS,yCAIpD,GAAI,CACF,OAAS,YAAY,mBAAmB,SAAS,QAAQ,QAAQ,WAAa,QAAU,WAAa,UAAW,EAAE,CAAC,CAAC,CACtH,MAAQ,CACN,MAAM,KACR,SACS,SAAS,SAAS,KAAK,GAAK,SAAS,SAAS,MAAM,EAG7D,GAAI,CACG,QAAQ,OAAO,IAAI,2BAA2B,CAAC,EAEzC,QAAQ,IAAI,aACrB,YAAY,aAAa,EAFzB,YAAY,kBAAkB,EAIhC,OAAS,YAAY,mBAAmB,SAAS,QAAQ,QAAQ,WAAa,QAAU,WAAa,UAAW,EAAE,CAAC,CAAC,CACtH,MAAQ,CACN,MAAM,KACR,KAEA,OAAM,KAEV,CAKI,OAAO,QAAW,WAAU,OAAS,OAAO,SAC5C,OAAO,QAAW,WAAU,OAAS,OAAO,SAEhD,YAAc,MAAM,OAAO,WAAW,UAAU,EAEhD,YAAY,GAAG,QAAS,SAAU,IAAK,CACrC,QAAQ,MAAM,MAAO,YAAa,EAAE,EACpC,QAAQ,OAAO,MAAO,WAAW,EAEjC,QAAQ,MAAM,MAAO,WAAY,EAAE,EACnC,QAAQ,OAAO,MAAO,UAAU,EAEhC,WAAW,YAAY,CACrB,KAAM,QACN,GACF,CAAC,CACH,CAAC,EAED,YAAY,GAAG,QAAS,UAAY,CAElC,IAAM,IAAM,QAAQ,KAAK,MAAO,WAAW,EAC3C,QAAQ,MAAM,MAAO,WAAY,GAAG,EACpC,QAAQ,OAAO,MAAO,UAAU,EAChC,cAAc,SAAS,EACvB,aAAa,IAAM,CACjB,QAAQ,KAAK,CAAC,CAChB,CAAC,CACH,CAAC,CACH,CAKA,MAAM,EAAE,KAAK,UAAY,CACvB,WAAW,YAAY,CACrB,KAAM,OACR,CAAC,EAED,QAAQ,SAAS,GAAG,CACtB,CAAC,EAED,SAAS,KAAO,CACd,IAAM,QAAU,QAAQ,KAAK,MAAO,UAAU,EACxC,IAAM,QAAQ,KAAK,MAAO,WAAW,EAI3C,GAAI,MAAQ,QAAS,CACf,MAAQ,KAAK,OACf,SAAS,MAAO,WAAY,IAAK,IAAU,GAAG,EAE9C,SAAS,MAAO,YAAa,IAAK,IAAU,GAAG,EAEjD,MACF,CAIA,GAAI,MAAQ,GAAI,CAEd,YAAY,IAAI,EAChB,MACF,CAEA,IAAM,QAAU,KAAK,SAAS,OAAQ,QAAS,GAAG,EAGtC,YAAY,MAAM,OAAO,GAGnC,QAAQ,MAAM,MAAO,WAAY,GAAG,EACpC,QAAQ,OAAO,MAAO,UAAU,EAChC,aAAa,GAAG,GAEhB,YAAY,KAAK,QAAS,UAAY,CACpC,QAAQ,MAAM,MAAO,WAAY,GAAG,EACpC,QAAQ,OAAO,MAAO,UAAU,EAChC,IAAI,CACN,CAAC,CAEL,CAEA,QAAQ,GAAG,qBAAsB,SAAU,IAAK,CAC9C,WAAW,YAAY,CACrB,KAAM,QACN,GACF,CAAC,EACD,QAAQ,KAAK,CAAC,CAChB,CAAC,EAED,QAAQ,GAAG,oBAAqB,SAAU,IAAK,CAC7C,WAAW,YAAY,CACrB,KAAM,QACN,GACF,CAAC,EACD,QAAQ,KAAK,CAAC,CAChB,CAAC,EAED,QAAQ,KAAK,OAAQ,UAAY,CAC/B,GAAI,WAAa,EAAG,CAClB,QAAQ,KAAK,QAAQ,EACrB,MACF,CACI,aAAa,mBAAqB,CAAC,aAAa,eAClD,WAAW,YAAY,CACrB,KAAM,UACN,IAAK,IAAI,MAAM,4JAA4J,CAC7K,CAAC,EAGH,QAAQ,KAAK,CAAC,CAChB,CAAC",
  "names": ["exports", "module", "realImport", "realRequire", "exports", "module", "exports", "module", "state", "waitDiff"]
}
